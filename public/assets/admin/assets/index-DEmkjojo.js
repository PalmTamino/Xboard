import{r as m,j as e,B as x,t as N,a as T}from"./index-_xd8OyP8.js";import{C as R,a as B,b as H,d as O,e as z,f as V,g as A,S as U,T as q,U as G}from"./user-nav-BBmBVa03.js";import{L as _,f as J,g as Q}from"./sidelinks-DLs_k-Mk.js";import{B as y,D as g,u as W,a as X,g as $,b as Y,c as Z,d as ee}from"./column-header-BLyyjrhJ.js";import{b as se,c as ae,a as re,D as te,P as le}from"./react-icons.esm-rZq2pt7A.js";import{I as D}from"./input-d0vtE30O.js";import{B as ne,C as ie,D as oe,E as ce,F as de,G as me}from"./index-BycJudEO.js";import{D as xe,e as ue,a as he,b as ge,c as je,d as fe,f as pe,g as ve}from"./button-DhrtVlOa.js";import{u as ye,F as Ce,a as j,b as f,c as p,d as v,e as w}from"./form-DIzSOdtk.js";import{z as h,t as we}from"./zod-x_8lkCGK.js";import{S as I}from"./switch-w5WyeRwk.js";import{S as Ne,a as be,b as Se,c as De,d as Fe}from"./select-Cqkdx-UJ.js";import{M as Te,E as ze}from"./index-hFh1_zyo.js";import{P as Ve,a as Ie,b as ke}from"./popover-C5eiPdqD.js";import{S as Le}from"./separator-lX8UNwTG.js";import{C as Ee}from"./confirm-dialog-CHz9pK2w.js";import{T as Ke}from"./trash-2-lI1I6nfk.js";import{u as Me}from"./useQuery-mr7Ep0hT.js";import"./index-CcyXqhZ9.js";import"./index-BwSRHYe4.js";import"./index-CX6PQ3zO.js";import"./index-BlMNiBlp.js";import"./IconTicket-COhvkaJH.js";import"./tooltip-B58e4dA7.js";import"./index-kwEAqj-e.js";import"./arrow-up-9fLptvj0.js";import"./clipboard-YH5zrf5X.js";import"./index-CRh0M8qI.js";import"./index-DScOlCGV.js";const Pe=h.object({id:h.number().nullable(),language:h.string().max(250),category:h.string().max(250),title:h.string().min(1).max(250),body:h.string().min(1),show:h.boolean()}),Re={id:null,language:"zh-CN",category:"",title:"",body:"",show:!1};function k({refreshData:l,dialogTrigger:d,type:s="add",defaultFormValues:n=Re}){const[a,r]=m.useState(!1),o=ye({resolver:we(Pe),defaultValues:n,mode:"onChange",shouldFocusError:!0}),u=new Te({html:!0});return m.useEffect(()=>{a&&n.id&&ne(n.id).then(({data:i})=>{o.reset(i)})},[n.id,o,a]),e.jsxs(xe,{onOpenChange:r,open:a,children:[e.jsx(ue,{asChild:!0,children:d||e.jsx(x,{variant:"outline",children:"添加知识"})}),e.jsxs(he,{className:"sm:max-w-[1025px]",children:[e.jsxs(ge,{children:[e.jsx(je,{children:s==="add"?"添加知识":"编辑知识"}),e.jsx(fe,{})]}),e.jsxs(Ce,{...o,children:[e.jsx(j,{control:o.control,name:"title",render:({field:i})=>e.jsxs(f,{children:[e.jsx(p,{children:"标题"}),e.jsx("div",{className:"relative ",children:e.jsx(v,{children:e.jsx(D,{placeholder:"请输入知识标题",...i})})}),e.jsx(w,{})]})}),e.jsx(j,{control:o.control,name:"category",render:({field:i})=>e.jsxs(f,{children:[e.jsx(p,{children:"分类"}),e.jsx("div",{className:"relative ",children:e.jsx(v,{children:e.jsx(D,{placeholder:"请输入分类，分类将会自动归类",...i})})}),e.jsx(w,{})]})}),e.jsx(j,{control:o.control,name:"language",render:({field:i})=>e.jsxs(f,{children:[e.jsx(p,{children:"语言"}),e.jsx(v,{children:e.jsxs(Ne,{value:i.value,onValueChange:i.onChange,children:[e.jsx(be,{children:e.jsx(Se,{placeholder:"请选择语言"})}),e.jsx(De,{children:[{field:"English",value:"en-US"},{field:"日本語",value:"ja-JP"},{field:"한국어",value:"ko-KR"},{field:"Tiếng Việt",value:"vi-VN"},{field:"简体中文",value:"zh-CN"},{field:"繁體中文",value:"zh-TW"}].map(c=>e.jsx(Fe,{value:c.value,className:"cursor-pointer",children:c.field},c.value))})]})})]})}),e.jsx(j,{control:o.control,name:"body",render:({field:i})=>e.jsxs(f,{children:[e.jsx(p,{children:"内容"}),e.jsx(v,{children:e.jsx(ze,{style:{height:"500px"},value:i.value,renderHTML:c=>u.render(c),onChange:({text:c})=>{i.onChange(c)}})}),e.jsx(w,{})]})}),e.jsx(j,{control:o.control,name:"show",render:({field:i})=>e.jsxs(f,{children:[e.jsx(p,{children:"显示"}),e.jsx("div",{className:"relative py-2",children:e.jsx(v,{children:e.jsx(I,{checked:i.value,onCheckedChange:i.onChange})})}),e.jsx(w,{})]})}),e.jsxs(pe,{children:[e.jsx(ve,{asChild:!0,children:e.jsx(x,{type:"button",variant:"outline",children:"取消"})}),e.jsx(x,{type:"submit",onClick:()=>{o.handleSubmit(i=>{ie(i).then(({data:c})=>{c&&(o.reset(),N.success("操作成功"),r(!1),l())})})()},children:"提交"})]})]})]})]})}function Be({column:l,title:d,options:s}){const n=l?.getFacetedUniqueValues(),a=new Set(l?.getFilterValue());return e.jsxs(Ve,{children:[e.jsx(Ie,{asChild:!0,children:e.jsxs(x,{variant:"outline",size:"sm",className:"h-8 border-dashed",children:[e.jsx(se,{className:"mr-2 h-4 w-4"}),d,a?.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{orientation:"vertical",className:"mx-2 h-4"}),e.jsx(y,{variant:"secondary",className:"rounded-sm px-1 font-normal lg:hidden",children:a.size}),e.jsx("div",{className:"hidden space-x-1 lg:flex",children:a.size>2?e.jsxs(y,{variant:"secondary",className:"rounded-sm px-1 font-normal",children:[a.size," selected"]}):s.filter(r=>a.has(r.value)).map(r=>e.jsx(y,{variant:"secondary",className:"rounded-sm px-1 font-normal",children:r.label},r.value))})]})]})}),e.jsx(ke,{className:"w-[200px] p-0",align:"start",children:e.jsxs(R,{children:[e.jsx(B,{placeholder:d}),e.jsxs(H,{children:[e.jsx(O,{children:"No results found."}),e.jsx(z,{children:s.map(r=>{const o=a.has(r.value);return e.jsxs(V,{onSelect:()=>{o?a.delete(r.value):a.add(r.value);const u=Array.from(a);l?.setFilterValue(u.length?u:void 0)},children:[e.jsx("div",{className:T("mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary",o?"bg-primary text-primary-foreground":"opacity-50 [&_svg]:invisible"),children:e.jsx(ae,{className:T("h-4 w-4")})}),r.icon&&e.jsx(r.icon,{className:"mr-2 h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:r.label}),n?.get(r.value)&&e.jsx("span",{className:"ml-auto flex h-4 w-4 items-center justify-center font-mono text-xs",children:n.get(r.value)})]},r.value)})}),a.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{}),e.jsx(z,{children:e.jsx(V,{onSelect:()=>l?.setFilterValue(void 0),className:"justify-center text-center",children:"Clear filters"})})]})]})]})})]})}function He({table:l,refetch:d,saveOrder:s,isSortMode:n}){const a=l.getState().columnFilters.length>0;return e.jsxs("div",{className:"flex items-center justify-between",children:[n?e.jsx("p",{className:"text-sm text-muted-foreground",children:"拖拽知识条目进行排序，完成后点击保存"}):e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(D,{placeholder:"搜索知识...",value:l.getColumn("title")?.getFilterValue()??"",onChange:r=>l.getColumn("title")?.setFilterValue(r.target.value),className:"h-9 w-[250px]"}),l.getColumn("category")&&e.jsx(Be,{column:l.getColumn("category"),title:"分类",options:Array.from(new Set(l.getCoreRowModel().rows.map(r=>r.getValue("category")))).map(r=>({label:r,value:r}))}),a&&e.jsxs(x,{variant:"ghost",onClick:()=>l.resetColumnFilters(),children:["重置",e.jsx(re,{className:"ml-2 h-4 w-4"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!n&&e.jsx(k,{refreshData:d}),e.jsx(x,{variant:n?"default":"outline",onClick:s,children:n?"保存排序":"编辑排序"})]})]})}const Oe=({refetch:l,isSortMode:d=!1})=>[{id:"drag-handle",header:()=>null,cell:()=>e.jsx("div",{className:d?"cursor-move":"opacity-0",children:e.jsx(te,{className:"size-4"})}),size:40,enableSorting:!1},{accessorKey:"id",header:({column:s})=>e.jsx(g,{column:s,title:"ID"}),cell:({row:s})=>e.jsx(y,{variant:"outline",className:"justify-center",children:s.getValue("id")}),enableSorting:!0,size:70},{accessorKey:"show",header:({column:s})=>e.jsx(g,{column:s,title:"状态"}),cell:({row:s})=>e.jsx("div",{className:"flex items-center",children:e.jsx(I,{defaultChecked:s.getValue("show"),onCheckedChange:async()=>{oe({id:s.original.id}).then(({data:n})=>{n||l()})}})}),enableSorting:!1,size:100},{accessorKey:"title",header:({column:s})=>e.jsx(g,{column:s,title:"标题"}),cell:({row:s})=>e.jsx("div",{className:"flex space-x-2",children:e.jsx("span",{className:"line-clamp-2 font-medium",children:s.getValue("title")})}),enableSorting:!0,size:600},{accessorKey:"category",header:({column:s})=>e.jsx(g,{column:s,title:"分类"}),cell:({row:s})=>e.jsx(y,{variant:"secondary",className:"max-w-[180px] truncate",children:s.getValue("category")}),enableSorting:!0,size:1800},{id:"actions",header:({column:s})=>e.jsx(g,{className:"justify-end",column:s,title:"操作"}),cell:({row:s})=>e.jsxs("div",{className:"flex items-center justify-end space-x-1",children:[e.jsx(k,{refreshData:l,dialogTrigger:e.jsxs(x,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-muted",children:[e.jsx(le,{className:"h-4 w-4 text-muted-foreground hover:text-foreground"}),e.jsx("span",{className:"sr-only",children:"编辑"})]}),type:"edit",defaultFormValues:s.original}),e.jsx(Ee,{title:"确认删除",description:"此操作将永久删除该知识库记录，删除后无法恢复。确定要继续吗？",confirmText:"删除",variant:"destructive",onConfirm:async()=>{ce({id:s.original.id}).then(({data:n})=>{n&&(N.success("删除成功"),l())})},children:e.jsxs(x,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-red-100 dark:hover:bg-red-900",children:[e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground hover:text-red-600 dark:hover:text-red-400"}),e.jsx("span",{className:"sr-only",children:"删除"})]})})]}),size:100}];function Ae(){const[l,d]=m.useState([]),[s,n]=m.useState([]),[a,r]=m.useState(!1),[o,u]=m.useState([]),[i,c]=m.useState({"drag-handle":!1}),{refetch:b,isLoading:Ue,data:qe}=Me({queryKey:["knowledge"],queryFn:async()=>{const{data:t}=await de();return u(t||[]),t}});m.useEffect(()=>{c({"drag-handle":a})},[a]);const L=(t,C)=>{a&&(t.dataTransfer.setData("text/plain",C.toString()),t.currentTarget.classList.add("opacity-50"))},E=(t,C)=>{if(!a)return;t.preventDefault(),t.currentTarget.classList.remove("bg-muted");const F=parseInt(t.dataTransfer.getData("text/plain"));if(F===C)return;const S=[...o],[P]=S.splice(F,1);S.splice(C,0,P),u(S)},K=async()=>{if(a)try{await me({ids:o.map(t=>t.id)}),await b(),r(!1),N.success("排序保存成功")}catch{N.error("排序保存失败")}else r(!0)},M=W({data:o,columns:Oe({refetch:b,isSortMode:a}),state:{sorting:s,columnFilters:l,columnVisibility:i},onSortingChange:n,onColumnFiltersChange:d,onColumnVisibilityChange:c,getCoreRowModel:$(),getFilteredRowModel:Y(),getPaginationRowModel:Z(),getSortedRowModel:ee(),pagination:a?{pageSize:Number.MAX_SAFE_INTEGER,pageIndex:0}:void 0,initialState:{columnPinning:{right:["actions"]}}});return e.jsx(X,{table:M,toolbar:t=>e.jsx(He,{table:t,refetch:b,saveOrder:K,isSortMode:a}),draggable:a,onDragStart:L,onDragEnd:t=>t.currentTarget.classList.remove("opacity-50"),onDragOver:t=>{t.preventDefault(),t.currentTarget.classList.add("bg-muted")},onDragLeave:t=>t.currentTarget.classList.remove("bg-muted"),onDrop:E,showPagination:!a})}function ys(){return e.jsxs(_,{children:[e.jsxs(J,{children:[e.jsx(U,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(q,{}),e.jsx(G,{})]})]}),e.jsxs(Q,{className:"flex flex-col",fixedHeight:!0,children:[e.jsx("div",{className:"mb-2 flex items-center justify-between space-y-2",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight mb-2",children:"知识库管理"}),e.jsx("p",{className:"text-muted-foreground",children:"在这里可以配置知识库，包括添加、删除、编辑等操作。"})]})}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(Ae,{})})]})]})}export{ys as default};
