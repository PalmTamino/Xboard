import{j as e,B as M,a as I,r as u,t as Q}from"./index-ra1jmRmU.js";import{c as J,C as W,a as X,b as Z,d as ee,e as V,f as z,g as te,S as se,T as ae,U as re}from"./user-nav-Ch7kI57y.js";import{L as ne,f as oe,g as ie}from"./sidelinks-B70MVRK0.js";import{B as S,D as C,u as le,g as ce,b as de,c as me,d as ue,e as xe,f as he,a as pe}from"./column-header-p2OHlx2E.js";import{u as ge}from"./useQuery-BPONQpNy.js";import{I as y}from"./input-BJSapCFH.js";import{b as L,c as je,a as fe,P as be}from"./react-icons.esm-BRv52UVg.js";import{P as K,a as A,b as U}from"./popover-C64Crl1x.js";import{S as ve}from"./separator-Ckt7QEUw.js";import{g as P,h as T,i as Y}from"./index-ngg4RcvF.js";import{D as Ce,e as Ne,a as ye,b as we,c as _e,f as Se}from"./button-BkBuHKqj.js";import{z as l,t as De}from"./zod-DftZp2aV.js";import{u as Me,F as Fe,a as j,b as f,c as b,e as N,f as F}from"./form-BdPgCkkB.js";import{f as Te,a0 as Ie,a1 as Oe,a2 as He,a3 as Pe}from"./index-vL3ySUIK.js";import{S as Ye,a as ke,b as Ve,c as ze,d as Ee}from"./select-ar7QGfF7.js";import{C as Re,b as Le}from"./calendar-BSDjNVAZ.js";import{a as D}from"./common-DR9A_A8_.js";import{M as E}from"./multiple-selector-J-H_ar2_.js";import{C as Ke}from"./confirm-dialog-Cgr3O3nI.js";import{S as Ae}from"./switch-koO8JJ-3.js";import{C as Ue,a as qe,b as $e}from"./collapsible-BbvJp1Ga.js";import{T as Be}from"./trash-2-DZs5wEr-.js";import"./index-CmmzV1O3.js";import"./index-OwEZQf1t.js";import"./index-QSXu8nGm.js";import"./index-NvRyusV4.js";import"./IconTicket-s_6DwrCY.js";import"./tooltip-uHmd8Pkm.js";import"./index-DBonxKbv.js";import"./arrow-up-Cu4ezgY6.js";import"./clipboard-Bl2zvJsv.js";import"./index-DGqrqZGX.js";/**
 * @license lucide-react v0.399.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=J("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]);function Qe({column:a,title:s,options:d}){const c=a?.getFacetedUniqueValues(),o=new Set(a?.getFilterValue());return e.jsxs(K,{children:[e.jsx(A,{asChild:!0,children:e.jsxs(M,{variant:"outline",size:"sm",className:"h-8 border-dashed",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),s,o?.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{orientation:"vertical",className:"mx-2 h-4"}),e.jsx(S,{variant:"secondary",className:"rounded-sm px-1 font-normal lg:hidden",children:o.size}),e.jsx("div",{className:"hidden space-x-1 lg:flex",children:o.size>2?e.jsxs(S,{variant:"secondary",className:"rounded-sm px-1 font-normal",children:[o.size," selected"]}):d.filter(i=>o.has(i.value)).map(i=>e.jsx(S,{variant:"secondary",className:"rounded-sm px-1 font-normal",children:i.label},i.value))})]})]})}),e.jsx(U,{className:"w-[200px] p-0",align:"start",children:e.jsxs(W,{children:[e.jsx(X,{placeholder:s}),e.jsxs(Z,{children:[e.jsx(ee,{children:"No results found."}),e.jsx(V,{children:d.map(i=>{const x=o.has(i.value);return e.jsxs(z,{onSelect:()=>{x?o.delete(i.value):o.add(i.value);const p=Array.from(o);a?.setFilterValue(p.length?p:void 0)},children:[e.jsx("div",{className:I("mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary",x?"bg-primary text-primary-foreground":"opacity-50 [&_svg]:invisible"),children:e.jsx(je,{className:I("h-4 w-4")})}),i.icon&&e.jsx(i.icon,{className:`mr-2 h-4 w-4 text-muted-foreground text-${i.color}`}),e.jsx("span",{children:i.label}),c?.get(i.value)&&e.jsx("span",{className:"ml-auto flex h-4 w-4 items-center justify-center font-mono text-xs",children:c.get(i.value)})]},i.value)})}),o.size>0&&e.jsxs(e.Fragment,{children:[e.jsx(te,{}),e.jsx(V,{children:e.jsx(z,{onSelect:()=>a?.setFilterValue(void 0),className:"justify-center text-center",children:"Clear filters"})})]})]})]})})]})}const H=a=>a===""||a===void 0?void 0:typeof a=="string"?Number(a):a,Je=l.object({id:l.number().optional(),name:l.string().min(1,"请输入优惠券名称"),code:l.string().optional(),type:l.union([l.string(),l.nativeEnum(P)]).transform(a=>typeof a=="string"?Number(a):a),value:l.union([l.string(),l.number()]).transform(a=>typeof a=="string"?Number(a):a).refine(a=>a>0,"优惠值必须大于0"),started_at:l.number(),ended_at:l.number(),limit_use:l.union([l.string(),l.number()]).optional().transform(H),limit_use_with_user:l.union([l.string(),l.number()]).optional().transform(H),generate_count:l.union([l.string(),l.number()]).optional().transform(H),limit_plan_ids:l.array(l.number()).default([]),limit_period:l.array(l.nativeEnum(T)).default([])}).refine(a=>a.ended_at>a.started_at,{message:"结束时间必须晚于开始时间",path:["ended_at"]}),R={name:"",code:"",type:P.AMOUNT,value:0,started_at:Math.floor(Date.now()/1e3),ended_at:Math.floor(Date.now()/1e3)+7*24*60*60,limit_use:"",limit_use_with_user:"",limit_plan_ids:[],limit_period:[],generate_count:""};function q({defaultValues:a,refetch:s,type:d="create",dialogTrigger:c=e.jsxs(M,{variant:"outline",size:"sm",className:"ml-auto hidden h-8 lg:flex",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"添加优惠券"]}),open:o,onOpenChange:i}){const[x,p]=u.useState(!1),h=o??x,w=i??p,[_,v]=u.useState([]),n=Me({resolver:De(Je),defaultValues:a||R});u.useEffect(()=>{a&&n.reset(a)},[a,n]),u.useEffect(()=>{Te().then(({data:t})=>v(t))},[]);const B=t=>{if(!t)return;const r=(m,g)=>{const O=new Date(g*1e3);return m.setHours(O.getHours(),O.getMinutes(),O.getSeconds()),Math.floor(m.getTime()/1e3)};t.from&&n.setValue("started_at",r(t.from,n.watch("started_at"))),t.to&&n.setValue("ended_at",r(t.to,n.watch("ended_at")))},G=async t=>{try{console.log("Form values before formatting:",t);const r={...t,type:Number(t.type),value:Number(t.value),limit_use:t.limit_use===""?void 0:Number(t.limit_use),limit_use_with_user:t.limit_use_with_user===""?void 0:Number(t.limit_use_with_user),generate_count:t.generate_count===""?void 0:Number(t.generate_count),limit_period:Array.isArray(t.limit_period)?t.limit_period:[],limit_plan_ids:Array.isArray(t.limit_plan_ids)?t.limit_plan_ids:[]};console.log("Formatted values:",r),await Ie(r),w(!1),d==="create"&&n.reset(R),s()}catch(r){console.error("保存优惠券失败:",r)}},k=(t,r)=>e.jsxs("div",{className:"flex-1 space-y-1.5",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:r}),e.jsx(y,{type:"datetime-local",step:"1",value:D(n.watch(t),"YYYY-MM-DDTHH:mm:ss"),onChange:m=>{const g=new Date(m.target.value);n.setValue(t,Math.floor(g.getTime()/1e3))},className:"h-8 [&::-webkit-calendar-picker-indicator]:hidden"})]});return e.jsxs(Ce,{open:h,onOpenChange:w,children:[c&&e.jsx(Ne,{asChild:!0,children:c}),e.jsxs(ye,{className:"sm:max-w-[425px]",children:[e.jsx(we,{children:e.jsx(_e,{children:d==="create"?"添加优惠券":"编辑优惠券"})}),e.jsx(Fe,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(G),className:"space-y-4",children:[e.jsx(j,{control:n.control,name:"name",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"优惠券名称"}),e.jsx(y,{placeholder:"请输入优惠券名称",...t}),e.jsx(N,{})]})}),e.jsxs(f,{children:[e.jsx(b,{children:"优惠券类型和值"}),e.jsxs("div",{className:"flex",children:[e.jsx(j,{control:n.control,name:"type",render:({field:t})=>e.jsxs(Ye,{value:t.value.toString(),onValueChange:t.onChange,children:[e.jsx(ke,{className:"flex-[1.2] rounded-r-none border-r-0 focus:z-10",children:e.jsx(Ve,{placeholder:"优惠券类型"})}),e.jsx(ze,{children:Object.entries(Y).map(([r,m])=>e.jsx(Ee,{value:r,children:m},r))})]})}),e.jsx(j,{control:n.control,name:"value",render:({field:t})=>e.jsx(y,{type:"number",placeholder:"请输入值",...t,onChange:r=>t.onChange(r.target.value===""?"":r.target.value),className:"flex-[2] rounded-none border-x-0 text-left"})}),e.jsx("div",{className:"flex min-w-[40px] items-center justify-center rounded-md rounded-l-none border border-l-0 border-input bg-muted/50 px-3 font-medium text-muted-foreground",children:e.jsx("span",{children:n.watch("type")===P.AMOUNT?"¥":"%"})})]})]}),e.jsxs(f,{children:[e.jsx(b,{children:"优惠券有效期"}),e.jsxs(K,{children:[e.jsx(A,{asChild:!0,children:e.jsxs(M,{variant:"outline",className:I("w-full justify-start text-left font-normal",!n.watch("started_at")&&"text-muted-foreground"),children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),D(n.watch("started_at"),"YYYY-MM-DD HH:mm:ss")," ","至"," ",D(n.watch("ended_at"),"YYYY-MM-DD HH:mm:ss")]})}),e.jsxs(U,{className:"w-auto p-0",align:"start",children:[e.jsx("div",{className:"border-b border-border",children:e.jsx(Le,{mode:"range",selected:{from:new Date(n.watch("started_at")*1e3),to:new Date(n.watch("ended_at")*1e3)},onSelect:B,numberOfMonths:2})}),e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-4",children:[k("started_at","开始时间"),e.jsx("div",{className:"mt-6 text-sm text-muted-foreground",children:"至"}),k("ended_at","结束时间")]})})]})]}),e.jsx(N,{})]}),e.jsx(j,{control:n.control,name:"limit_use",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"最大使用次数"}),e.jsx(y,{type:"number",min:0,placeholder:"限制最大使用次数，留空则不限制",...t,value:t.value===void 0?"":t.value,onChange:r=>t.onChange(r.target.value===""?"":r.target.value),className:"h-9"}),e.jsx(F,{className:"text-xs",children:"设置优惠券的总使用次数限制，留空表示不限制使用次数"}),e.jsx(N,{})]})}),e.jsx(j,{control:n.control,name:"limit_use_with_user",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"每个用户可使用次数"}),e.jsx(y,{type:"number",min:0,placeholder:"限制每个用户可使用次数，留空则不限制",...t,value:t.value===void 0?"":t.value,onChange:r=>t.onChange(r.target.value===""?"":r.target.value),className:"h-9"}),e.jsx(F,{className:"text-xs",children:"限制每个用户可使用该优惠券的次数，留空表示不限制单用户使用次数"}),e.jsx(N,{})]})}),e.jsx(j,{control:n.control,name:"limit_period",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"指定周期"}),e.jsx(E,{options:Object.entries(T).filter(([r])=>isNaN(Number(r))).map(([r,m])=>({label:m,value:r})),onChange:r=>{if(r.length===0){t.onChange([]);return}const m=r.map(g=>T[g.value]);t.onChange(m)},value:(t.value||[]).map(r=>({label:Object.entries(T).find(([m,g])=>g===r)?.[1]||"",value:Object.entries(T).find(([m,g])=>g===r)?.[0]||""})),placeholder:"限制指定周期可以使用优惠，留空则不限制",emptyIndicator:e.jsx("p",{className:"text-center text-sm text-muted-foreground",children:"没有找到匹配的周期"})}),e.jsx(F,{className:"text-xs",children:"选择可以使用优惠券的订阅周期，留空表示不限制使用周期"}),e.jsx(N,{})]})}),e.jsx(j,{control:n.control,name:"limit_plan_ids",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"指定订阅"}),e.jsx(E,{options:_?.map(r=>({label:r.name,value:r.id.toString()}))||[],onChange:r=>t.onChange(r.map(m=>Number(m.value))),value:(_||[]).filter(r=>(t.value||[]).includes(r.id)).map(r=>({label:r.name,value:r.id.toString()})),placeholder:"限制指定订阅可以使用优惠，留空则不限制",emptyIndicator:e.jsx("p",{className:"text-center text-sm text-muted-foreground",children:"没有找到匹配的订阅"})}),e.jsx(N,{})]})}),d==="create"&&e.jsxs(e.Fragment,{children:[e.jsx(j,{control:n.control,name:"code",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"自定义优惠码"}),e.jsx(y,{placeholder:"自定义优惠码，留空则自动生成",...t,className:"h-9"}),e.jsx(F,{className:"text-xs",children:"可以自定义优惠码，留空则系统自动生成"}),e.jsx(N,{})]})}),e.jsx(j,{control:n.control,name:"generate_count",render:({field:t})=>e.jsxs(f,{children:[e.jsx(b,{children:"批量生成数量"}),e.jsx(y,{type:"number",min:0,placeholder:"批量生成优惠码数量，留空则生成单个",...t,value:t.value===void 0?"":t.value,onChange:r=>t.onChange(r.target.value===""?"":r.target.value),className:"h-9"}),e.jsx(F,{className:"text-xs",children:"批量生成多个优惠码，留空则只生成单个优惠码"}),e.jsx(N,{})]})})]}),e.jsx(Se,{children:e.jsx(M,{type:"submit",disabled:n.formState.isSubmitting,children:n.formState.isSubmitting?"保存中...":"保存"})})]})})]})]})}function We({table:a,refetch:s}){const d=a.getState().columnFilters.length>0;return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-1 items-center space-x-2",children:[e.jsx(y,{placeholder:"搜索优惠券...",value:a.getColumn("name")?.getFilterValue()??"",onChange:c=>a.getColumn("name")?.setFilterValue(c.target.value),className:"h-9 w-[150px] lg:w-[250px]"}),a.getColumn("type")&&e.jsx(Qe,{column:a.getColumn("type"),title:"类型",options:Object.entries(Y).map(([c,o])=>({value:c,label:o}))}),d&&e.jsxs(M,{variant:"ghost",onClick:()=>a.resetColumnFilters(),className:"h-8 px-2 lg:px-3",children:["重置",e.jsx(fe,{className:"ml-2 h-4 w-4"})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx(q,{refetch:s})})]})}const $=u.createContext(void 0);function Xe({children:a,refetch:s}){const[d,c]=u.useState(!1),[o,i]=u.useState(null),x=h=>{i(h),c(!0)},p=()=>{c(!1),i(null)};return e.jsxs($.Provider,{value:{isOpen:d,currentCoupon:o,openEdit:x,closeEdit:p},children:[a,o&&e.jsx(q,{defaultValues:o,refetch:s,type:"edit",open:d,onOpenChange:c})]})}function Ze(){const a=u.useContext($);if(a===void 0)throw new Error("useCouponEdit must be used within a CouponEditProvider");return a}const et=a=>[{accessorKey:"id",header:({column:s})=>e.jsx(C,{column:s,title:"ID"}),cell:({row:s})=>e.jsx(S,{children:s.original.id}),enableSorting:!0},{accessorKey:"show",header:({column:s})=>e.jsx(C,{column:s,title:"启用"}),cell:({row:s})=>e.jsx(Ae,{defaultChecked:s.original.show,onCheckedChange:d=>{Oe({id:s.original.id,show:d}).then(({data:c})=>!c&&a())}}),enableSorting:!1},{accessorKey:"name",header:({column:s})=>e.jsx(C,{column:s,title:"卷名称"}),cell:({row:s})=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{children:s.original.name})}),enableSorting:!1,size:800},{accessorKey:"type",header:({column:s})=>e.jsx(C,{column:s,title:"类型"}),cell:({row:s})=>e.jsx(S,{variant:"outline",children:Y[s.original.type]}),enableSorting:!0},{accessorKey:"code",header:({column:s})=>e.jsx(C,{column:s,title:"卷码"}),cell:({row:s})=>e.jsx(S,{variant:"secondary",children:s.original.code}),enableSorting:!0},{accessorKey:"limit_use",header:({column:s})=>e.jsx(C,{column:s,title:"剩余次数"}),cell:({row:s})=>e.jsx(S,{variant:"outline",children:s.original.limit_use}),enableSorting:!0},{accessorKey:"#",header:({column:s})=>e.jsx(C,{column:s,title:"有效期"}),cell:({row:s})=>{const[d,c]=u.useState(!1),o=Date.now(),i=s.original.started_at*1e3,x=s.original.ended_at*1e3,p=o>x,h=o<i,w=Math.ceil((x-o)/(1e3*60*60*24)),v=p?{label:`已过期${Math.abs(w)}天`,color:"bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-400"}:h?{label:`${Math.abs(Math.ceil((i-o)/(1e3*60*60*24)))}天后开始`,color:"bg-yellow-50 text-yellow-600 dark:bg-yellow-500/10 dark:text-yellow-400"}:{label:`剩余${w}天`,color:"bg-green-50 text-green-600 dark:bg-green-500/10 dark:text-green-400"};return e.jsxs(Ue,{open:d,onOpenChange:c,children:[e.jsx(qe,{asChild:!0,children:e.jsxs("div",{className:"group -m-0.5 flex max-w-[280px] cursor-pointer items-center gap-2 rounded-md p-0.5 transition-colors hover:bg-muted/40",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2",children:[e.jsx("div",{className:I("whitespace-nowrap rounded-md px-1.5 py-0.5 text-xs font-medium",v.color),children:v.label}),e.jsxs("div",{className:"flex min-w-0 items-center gap-1 text-muted-foreground",children:[e.jsx("div",{className:"truncate text-xs",children:D(s.original.started_at,"MM/DD HH:mm")}),e.jsx("div",{className:"shrink-0 opacity-30",children:"→"}),e.jsx("div",{className:"truncate text-xs",children:D(s.original.ended_at,"MM/DD HH:mm")})]})]}),e.jsx(Ge,{className:I("h-3.5 w-3.5 shrink-0 text-muted-foreground/50 transition-transform duration-200",d&&"rotate-180")})]})}),e.jsx($e,{children:e.jsx("div",{className:"px-0.5 pb-0.5 pt-1.5",children:e.jsxs("div",{className:"space-y-1.5 border-l-2 border-muted pl-3 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"开始时间"}),e.jsx("span",{className:"font-medium text-foreground",children:D(s.original.started_at,"YYYY/MM/DD HH:mm")})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"结束时间"}),e.jsx("span",{className:"font-medium text-foreground",children:D(s.original.ended_at,"YYYY/MM/DD HH:mm")})]})]})})})]})},enableSorting:!1,size:8e3},{id:"actions",header:({column:s})=>e.jsx(C,{className:"justify-end",column:s,title:"操作"}),cell:({row:s})=>{const{openEdit:d}=Ze();return e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsxs(M,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-muted",onClick:()=>d(s.original),children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground hover:text-foreground"}),e.jsx("span",{className:"sr-only",children:"编辑"})]}),e.jsx(Ke,{title:"确认删除",description:"此操作将永久删除该优惠券，删除后无法恢复。确定要继续吗？",confirmText:"删除",variant:"destructive",onConfirm:async()=>{He({id:s.original.id}).then(({data:c})=>{c&&(Q.success("删除成功"),a())})},children:e.jsxs(M,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-red-100 dark:hover:bg-red-900",children:[e.jsx(Be,{className:"h-4 w-4 text-muted-foreground hover:text-red-600 dark:hover:text-red-400"}),e.jsx("span",{className:"sr-only",children:"删除"})]})})]})}}];function tt(){const[a,s]=u.useState({}),[d,c]=u.useState({}),[o,i]=u.useState([]),[x,p]=u.useState([]),[h,w]=u.useState({pageIndex:0,pageSize:10}),{refetch:_,data:v}=ge({queryKey:["couponList",h,o,x],queryFn:()=>Pe({pageSize:h.pageSize,current:h.pageIndex+1,filter:o,sort:x})}),n=le({data:v?.data??[],columns:et(_),state:{sorting:x,columnVisibility:d,rowSelection:a,columnFilters:o,pagination:h},pageCount:Math.ceil((v?.total??0)/h.pageSize),rowCount:v?.total??0,manualPagination:!0,manualFiltering:!0,manualSorting:!0,enableRowSelection:!0,onRowSelectionChange:s,onSortingChange:p,onColumnFiltersChange:i,onColumnVisibilityChange:c,onPaginationChange:w,getCoreRowModel:ce(),getFilteredRowModel:de(),getPaginationRowModel:me(),getSortedRowModel:ue(),getFacetedRowModel:xe(),getFacetedUniqueValues:he(),initialState:{columnPinning:{right:["actions"]}}});return e.jsx(Xe,{refetch:_,children:e.jsx("div",{className:"space-y-4",children:e.jsx(pe,{table:n,toolbar:e.jsx(We,{table:n,refetch:_})})})})}function Pt(){return e.jsxs(ne,{children:[e.jsxs(oe,{children:[e.jsx(se,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(ae,{}),e.jsx(re,{})]})]}),e.jsxs(ie,{className:"flex flex-col",fixedHeight:!0,children:[e.jsx("div",{className:"mb-2 flex items-center justify-between space-y-2",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"优惠券管理"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"在这里可以查看优惠券，包括增加、查看、删除等操作。"})]})}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(tt,{})})]})]})}export{Pt as default};
