import{r as i,j as e,B as f,a as R,t as T}from"./index-ra1jmRmU.js";import{S as k,T as B,U as E}from"./user-nav-Ch7kI57y.js";import{L as K,f as O,g as H}from"./sidelinks-B70MVRK0.js";import{D as y,B as U,u as q,a as Q,g as $,b as A,c as G,d as J}from"./column-header-p2OHlx2E.js";import{k as W,l as X,m as Y,u as Z,n as ee,o as se,p as ae}from"./index-vL3ySUIK.js";import{S as te}from"./switch-koO8JJ-3.js";import{T as ne,a as re,b as le,c as oe}from"./tooltip-uHmd8Pkm.js";import{D as ie,e as ce,a as de,b as me,c as xe,f as he,g as ue}from"./button-BkBuHKqj.js";import{u as ge,F as pe,a as h,b as u,c as g,d as p,f as V,e as j}from"./form-BdPgCkkB.js";import{I as b}from"./input-BJSapCFH.js";import{S as je,a as fe,b as ye,c as be,d as ve}from"./select-ar7QGfF7.js";import{z as c,t as Se}from"./zod-DftZp2aV.js";import{D as Ce}from"./DynamicForm-BSmL5V7X.js";import{D as Ne,P as we,a as De}from"./react-icons.esm-BRv52UVg.js";import{C as Fe}from"./confirm-dialog-Cgr3O3nI.js";import{u as Te}from"./question-circle-DbxGI5ux.js";import{T as Pe}from"./trash-2-DZs5wEr-.js";import{u as _e}from"./useQuery-BPONQpNy.js";import"./index-CmmzV1O3.js";import"./index-OwEZQf1t.js";import"./index-QSXu8nGm.js";import"./index-NvRyusV4.js";import"./IconTicket-s_6DwrCY.js";import"./arrow-up-Cu4ezgY6.js";import"./clipboard-Bl2zvJsv.js";import"./index-DGqrqZGX.js";import"./index-DBonxKbv.js";import"./textarea-C2MOf6wm.js";const Le=c.object({id:c.number().nullable(),name:c.string().min(2,"名称至少需要2个字符").max(30,"名称不能超过30个字符"),icon:c.string().optional().nullable(),notify_domain:c.string().refine(l=>!l||/^https?:\/\/\S+/.test(l),"请输入有效的URL").optional().nullable(),handling_fee_fixed:c.coerce.number().min(0).optional().nullable(),handling_fee_percent:c.coerce.number().min(0).max(100).optional().nullable(),payment:c.string().min(1,"请选择支付接口"),config:c.record(c.string(),c.string())}),z={id:null,name:"",icon:"",notify_domain:"",handling_fee_fixed:0,handling_fee_percent:0,payment:"",config:{}};function I({refetch:l,dialogTrigger:d,type:a="add",defaultFormValues:o=z}){const[n,m]=i.useState(!1),[x,v]=i.useState(!1),[P,D]=i.useState([]),[S,_]=i.useState([]),r=ge({resolver:Se(Le),defaultValues:o,mode:"onChange"}),C=r.watch("payment");i.useEffect(()=>{n&&(async()=>{const{data:t}=await W();D(t)})()},[n]),i.useEffect(()=>{if(!C||!n)return;(async()=>{try{const t={payment:C,...a==="edit"&&{id:Number(r.getValues("id"))}},{data:N}=await X(t);_(N);const w=N.reduce((F,M)=>(M.field_name&&(F[M.field_name]=M.value??""),F),{});r.setValue("config",w)}catch{T.error("获取支付方式表单失败")}})()},[C,n,r,a]);const L=async s=>{v(!0),(await Y(s)).data&&(T.success("保存成功"),r.reset(z),l(),m(!1)),v(!1)};return e.jsxs(ie,{open:n,onOpenChange:m,children:[e.jsx(ce,{asChild:!0,children:d||e.jsx(f,{variant:"outline",children:"添加支付方式"})}),e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsx(xe,{children:a==="add"?"添加支付方式":"编辑支付方式"})}),e.jsx(pe,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(L),className:"space-y-4",children:[e.jsx(h,{control:r.control,name:"name",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"显示名称"}),e.jsx(p,{children:e.jsx(b,{placeholder:"请输入支付名称",...s})}),e.jsx(V,{children:"用于前端显示"}),e.jsx(j,{})]})}),e.jsx(h,{control:r.control,name:"icon",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"图标URL"}),e.jsx(p,{children:e.jsx(b,{placeholder:"https://example.com/icon.svg",...s})}),e.jsx(V,{children:"用于前端显示的图标地址"}),e.jsx(j,{})]})}),e.jsx(h,{control:r.control,name:"notify_domain",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"通知域名"}),e.jsx(p,{children:e.jsx(b,{placeholder:"https://example.com",...s})}),e.jsx(V,{children:"网关通知将发送到该域名"}),e.jsx(j,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(h,{control:r.control,name:"handling_fee_percent",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"百分比手续费(%)"}),e.jsx(p,{children:e.jsx(b,{type:"number",placeholder:"0-100",...s})}),e.jsx(j,{})]})}),e.jsx(h,{control:r.control,name:"handling_fee_fixed",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"固定手续费"}),e.jsx(p,{children:e.jsx(b,{type:"number",placeholder:"0",...s})}),e.jsx(j,{})]})})]}),e.jsx(h,{control:r.control,name:"payment",render:({field:s})=>e.jsxs(u,{children:[e.jsx(g,{children:"支付接口"}),e.jsxs(je,{value:s.value,onValueChange:s.onChange,children:[e.jsx(p,{children:e.jsx(fe,{children:e.jsx(ye,{placeholder:"请选择支付接口"})})}),e.jsx(be,{children:P.map(t=>e.jsx(ve,{value:t,children:t},t))})]}),e.jsx(j,{})]})}),S.map(s=>e.jsx(h,{control:r.control,name:`config.${s.field_name}`,render:({field:t})=>e.jsxs(u,{children:[e.jsx(g,{children:s.label}),e.jsx(p,{children:Ce(s,t)}),e.jsx(j,{})]})},s.field_name)),e.jsxs(he,{className:"gap-2",children:[e.jsx(ue,{asChild:!0,children:e.jsx(f,{type:"button",variant:"outline",children:"取消"})}),e.jsx(f,{type:"submit",disabled:x,className:R(x&&"cursor-not-allowed opacity-50"),children:x?"保存中...":"提交"})]})]})})]})]})}const Me=({refetch:l,isSortMode:d=!1})=>[{id:"drag-handle",header:()=>null,cell:()=>e.jsx("div",{className:d?"cursor-move":"opacity-0",children:e.jsx(Ne,{className:"size-4"})}),size:40,enableSorting:!1},{accessorKey:"id",header:({column:a})=>e.jsx(y,{column:a,title:"ID"}),cell:({row:a})=>e.jsx(U,{variant:"outline",children:a.getValue("id")}),enableSorting:!0,size:60},{accessorKey:"enable",header:({column:a})=>e.jsx(y,{column:a,title:"启用"}),cell:({row:a})=>e.jsx(te,{defaultChecked:a.getValue("enable"),onCheckedChange:async()=>{const{data:o}=await Z({id:a.original.id});o||l()}}),enableSorting:!1,size:100},{accessorKey:"name",header:({column:a})=>e.jsx(y,{column:a,title:"显示名称"}),cell:({row:a})=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"max-w-[200px] truncate font-medium",children:a.getValue("name")})}),enableSorting:!1,size:200},{accessorKey:"payment",header:({column:a})=>e.jsx(y,{column:a,title:"支付接口"}),cell:({row:a})=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"max-w-[200px] truncate font-medium",children:a.getValue("payment")})}),enableSorting:!1,size:200},{accessorKey:"notify_url",header:({column:a})=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(y,{column:a,title:"通知地址"}),e.jsx(ne,{delayDuration:100,children:e.jsxs(re,{children:[e.jsx(le,{className:"ml-1",children:e.jsx(Te,{className:"h-4 w-4"})}),e.jsx(oe,{children:"支付网关将会把数据通知到本地址，请通过防火墙放行本地址。"})]})})]}),cell:({row:a})=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"max-w-[300px] truncate font-medium",children:a.getValue("notify_url")})}),enableSorting:!1,size:3e3},{id:"actions",header:({column:a})=>e.jsx(y,{className:"justify-end",column:a,title:"操作"}),cell:({row:a})=>e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(I,{refetch:l,dialogTrigger:e.jsxs(f,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-muted",children:[e.jsx(we,{className:"h-4 w-4 text-muted-foreground hover:text-foreground"}),e.jsx("span",{className:"sr-only",children:"编辑"})]}),type:"edit",defaultFormValues:a.original}),e.jsx(Fe,{title:"删除确认",description:"确定要删除该支付方式吗？此操作无法撤销。",onConfirm:async()=>{const{data:o}=await ee({id:a.original.id});o&&l()},children:e.jsxs(f,{variant:"ghost",size:"icon",className:"h-8 w-8 hover:bg-destructive/10",children:[e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"}),e.jsx("span",{className:"sr-only",children:"删除"})]})})]}),size:100}];function Ve({table:l,refetch:d,saveOrder:a,isSortMode:o}){const n=l.getState().columnFilters.length>0;return e.jsxs("div",{className:"flex items-center justify-between",children:[o?e.jsx("p",{className:"text-sm text-muted-foreground",children:"拖拽支付方式进行排序，完成后点击保存"}):e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{placeholder:"搜索支付方式...",value:l.getColumn("name")?.getFilterValue()??"",onChange:m=>l.getColumn("name")?.setFilterValue(m.target.value),className:"h-9 w-[250px]"}),n&&e.jsxs(f,{variant:"ghost",onClick:()=>l.resetColumnFilters(),children:["重置",e.jsx(De,{className:"ml-2 h-4 w-4"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!o&&e.jsx(I,{refetch:d}),e.jsx(f,{variant:o?"default":"outline",onClick:a,children:o?"保存排序":"编辑排序"})]})]})}function ze(){const[l,d]=i.useState([]),[a,o]=i.useState([]),[n,m]=i.useState(!1),[x,v]=i.useState([]),[P,D]=i.useState({"drag-handle":!1}),{refetch:S}=_e({queryKey:["paymentList"],queryFn:async()=>{const{data:s}=await se();return v(s?.map(t=>({...t,enable:!!t.enable}))||[]),s}});i.useEffect(()=>{D({"drag-handle":n})},[n]);const _=(s,t)=>{n&&(s.dataTransfer.setData("text/plain",t.toString()),s.currentTarget.classList.add("opacity-50"))},r=(s,t)=>{if(!n)return;s.preventDefault(),s.currentTarget.classList.remove("bg-muted");const N=parseInt(s.dataTransfer.getData("text/plain"));if(N===t)return;const w=[...x],[F]=w.splice(N,1);w.splice(t,0,F),v(w)},C=async()=>{if(n)try{await ae({ids:x.map(s=>s.id)}),await S(),m(!1),T.success("排序保存成功")}catch{T.error("排序保存失败")}else m(!0)},L=q({data:x,columns:Me({refetch:S,isSortMode:n}),state:{sorting:a,columnFilters:l,columnVisibility:P},onSortingChange:o,onColumnFiltersChange:d,onColumnVisibilityChange:D,getCoreRowModel:$(),getFilteredRowModel:A(),getPaginationRowModel:G(),getSortedRowModel:J(),initialState:{pagination:{pageSize:10},columnPinning:{right:["actions"]}},pageCount:n?1:void 0});return e.jsx(Q,{table:L,toolbar:s=>e.jsx(Ve,{table:s,refetch:S,saveOrder:C,isSortMode:n}),draggable:n,onDragStart:_,onDragEnd:s=>s.currentTarget.classList.remove("opacity-50"),onDragOver:s=>{s.preventDefault(),s.currentTarget.classList.add("bg-muted")},onDragLeave:s=>s.currentTarget.classList.remove("bg-muted"),onDrop:r,showPagination:!n})}function cs(){return e.jsxs(K,{children:[e.jsxs(O,{className:"flex items-center justify-between",children:[e.jsx(k,{}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(B,{}),e.jsx(E,{})]})]}),e.jsxs(H,{children:[e.jsx("header",{className:"mb-2 flex items-center justify-between space-y-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"支付配置"})}),e.jsx("p",{className:"text-muted-foreground",children:"在这里可以配置支付方式，包括支付宝、微信等。"})]})}),e.jsx("section",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(ze,{})})]})]})}export{cs as default};
